# ボールマージゲーム 企画書

## 1. ゲーム概要

| 項目 | 内容 |
|------|------|
| タイトル | **ボールマージゲーム (Ball Merge Game)** |
| ジャンル | 落ちもの物理演算パズル |
| コンセプト | 球技のボールを落として合体させ、より大きなボールに進化させるゲーム |
| プラットフォーム | Webブラウザ (HTML5 / JavaScript) |
| 対応デバイス | PC (マウス操作) / スマートフォン (タッチ操作) |
| 技術スタック | HTML5 Canvas + Matter.js (物理エンジン) |
| ファイル構成 | 単一HTMLファイル (`index.html`) で完結 |

---

## 2. ボール進化表 (全11段階)

同じボール同士が接触すると、1段階上のボールに合体進化する。

| レベル | ボール名 | 直径 (px) | 合体スコア | 表示色 (HEX) | 色名 | 実際の球技 |
|:------:|----------|:---------:|:----------:|:------------:|------|-----------|
| 1 | ピンポン玉 | 30 | 10 | `#F5F5F5` | 白 | 卓球 |
| 2 | ゴルフボール | 40 | 30 | `#FFFDE7` | クリーム | ゴルフ |
| 3 | スカッシュボール | 52 | 60 | `#212121` | 黒 | スカッシュ |
| 4 | テニスボール | 66 | 100 | `#CDDC39` | 黄緑 | テニス |
| 5 | 野球ボール | 82 | 150 | `#ECEFF1` | オフホワイト | 野球 |
| 6 | ソフトボール | 100 | 210 | `#FFF176` | イエロー | ソフトボール |
| 7 | ハンドボール | 120 | 280 | `#FF8A65` | オレンジ | ハンドボール |
| 8 | サッカーボール | 142 | 360 | `#E0E0E0` | ライトグレー | サッカー |
| 9 | バレーボール | 166 | 450 | `#42A5F5` | ブルー | バレーボール |
| 10 | バスケットボール | 192 | 550 | `#E65100` | ダークオレンジ | バスケットボール |
| 11 | バランスボール | 220 | 660 | `#EC407A` | ピンク | フィットネス |

### ボールデザイン方針

- 各ボールはCanvas上で円として描画し、ボール名の特徴的な模様を簡略化して描く
  - ピンポン玉: 白い円
  - ゴルフボール: クリーム色の円 + ディンプル (小さな点) を数個
  - テニスボール: 黄緑の円 + 白い曲線ライン
  - 野球ボール: 白い円 + 赤い縫い目ライン
  - サッカーボール: 白い円 + 黒い五角形パターン
  - バスケットボール: オレンジの円 + 黒いラインパターン
  - その他: 固有色の円 + ボール名テキスト
- ボール中央にレベル数字を小さく表示 (デバッグ兼ユーザー補助)

---

## 3. ゲームルール

### 3.1 基本ルール

| ルール | 詳細 |
|--------|------|
| **落下操作** | プレイヤーはゲームエリアの上部から左右にボールの位置を調整し、クリック/タップで落下させる |
| **合体進化** | 同じ種類のボール同士が接触すると、1段階上のボールに合体する (2つ -> 1つ) |
| **最大ボールの消滅** | レベル11 (バランスボール) 同士が合体した場合、両方消滅しボーナススコアを獲得 |
| **ゲームオーバー** | ボールが容器の上限ライン (デッドライン) を超えた状態が一定時間 (2秒) 継続したらゲームオーバー |
| **落下クールダウン** | ボール落下後、次のボールを落とせるまで0.5秒のクールダウン |

### 3.2 ボール出現ルール

| 項目 | 詳細 |
|------|------|
| **出現範囲** | レベル1~5 (ピンポン玉~野球ボール) の5種類からランダムに選出 |
| **Next表示** | 次に落とすボールを画面上部に常時プレビュー表示 |
| **出現確率** | 均等 (各20%) ※将来的に難易度調整で変更可能 |

### 3.3 合体の物理挙動

- 合体時、2つのボールの中間座標に新しいボールが生成される
- 合体時に軽い「弾け」エフェクト (パーティクル演出) を表示
- 新しいボールには合体前のボールの運動量が引き継がれる (Matter.jsの物理演算に依存)
- 合体によって他のボール同士が接触し、連鎖的に合体が発生する場合がある

---

## 4. スコアリングシステム

### 4.1 合体スコア

合体が発生するたびに、進化先ボールの合体スコアがそのまま加算される。

| 合体パターン | 獲得スコア |
|-------------|:----------:|
| ピンポン玉 + ピンポン玉 -> ゴルフボール | 30 |
| ゴルフボール + ゴルフボール -> スカッシュボール | 60 |
| スカッシュボール + スカッシュボール -> テニスボール | 100 |
| テニスボール + テニスボール -> 野球ボール | 150 |
| 野球ボール + 野球ボール -> ソフトボール | 210 |
| ソフトボール + ソフトボール -> ハンドボール | 280 |
| ハンドボール + ハンドボール -> サッカーボール | 360 |
| サッカーボール + サッカーボール -> バレーボール | 450 |
| バレーボール + バレーボール -> バスケットボール | 550 |
| バスケットボール + バスケットボール -> バランスボール | 660 |
| バランスボール + バランスボール -> **消滅** | **1000 (ボーナス)** |

### 4.2 連鎖ボーナス

1回の落下操作から派生して、連続して合体が発生した場合に連鎖ボーナスが加算される。

| 連鎖数 | ボーナス倍率 | 計算方法 |
|:------:|:----------:|----------|
| 1連鎖 (通常) | x1.0 | 合体スコア x 1.0 |
| 2連鎖 | x1.5 | 合体スコア x 1.5 |
| 3連鎖 | x2.0 | 合体スコア x 2.0 |
| 4連鎖 | x2.5 | 合体スコア x 2.5 |
| N連鎖 | x(1.0 + 0.5 x (N-1)) | 0.5刻みで増加 |

- 連鎖判定: ボール落下後、一定時間 (1.5秒) 以内に連続して合体が発生した場合を連鎖と判定
- 連鎖表示: 2連鎖以上で画面中央に「2 Chain!」等のテキストを一時表示

### 4.3 ハイスコア

- ローカルストレージ (`localStorage`) にハイスコアを保存
- ゲームオーバー時にハイスコア更新の場合は「NEW RECORD!」と表示

---

## 5. UI仕様

### 5.1 画面レイアウト

```
+--------------------------------------------------+
|              ボールマージゲーム                       |
+--------------------------------------------------+
|  SCORE: 12345          BEST: 99999               |
+--------------------------------------------------+
|  [NEXT]                                          |
|  ( o )    <- 次のボール表示                        |
|                                                   |
|  - - - - - - - - - - デッドライン - - - - - - - -  |
|  |                                           |    |
|  |        +-----400px-----+                  |    |
|  |        |                |                 |    |
|  |        |   ゲームエリア   |  600px          |    |
|  |        |   (物理演算)    |                 |    |
|  |        |                |                 |    |
|  |        |    O           |                 |    |
|  |        |   OOo  o       |                 |    |
|  |        |  OOOOooo       |                 |    |
|  |        +----------------+                 |    |
+--------------------------------------------------+
```

### 5.2 ゲームエリア

| 項目 | 値 |
|------|-----|
| 幅 | 400px |
| 高さ | 600px |
| 壁の厚さ | 10px (左右・底面) |
| デッドライン位置 | 上端から80px |
| 背景色 | `#FFF8E1` (淡いクリーム色) |
| 壁の色 | `#5D4037` (ダークブラウン) |
| デッドライン色 | `#F44336` (赤、点線表示) |

### 5.3 UI要素

| 要素 | 位置 | 仕様 |
|------|------|------|
| タイトル | 画面上部 | 「Ball Merge Game」フォントサイズ24px、太字 |
| スコア表示 | ゲームエリア上部左 | 「SCORE: XXXXX」リアルタイム更新 |
| ハイスコア表示 | ゲームエリア上部右 | 「BEST: XXXXX」ローカルストレージから読み込み |
| Nextボール | ゲームエリア上部中央 | 次に落下するボールのプレビュー (小さめ表示) |
| ドロップガイド | ボール位置から下方 | 縦の点線で落下予測位置を表示 |
| ゲームオーバー | 画面中央オーバーレイ | 半透明黒背景 + 「GAME OVER」+ 最終スコア + リトライボタン |
| リトライボタン | ゲームオーバー画面内 | 「Retry」ボタン、クリック/タップでゲームリセット |
| 連鎖表示 | ゲームエリア中央 | 「X Chain!」フェードアウトアニメーション付き |

### 5.4 レスポンシブ対応

| 画面幅 | 挙動 |
|--------|------|
| 600px以上 | ゲームエリアを中央配置、原寸表示 |
| 600px未満 | Canvas全体を画面幅に合わせて縮小 (アスペクト比維持) |

- viewport メタタグで `width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no` を設定
- タッチ操作時のスクロール・ズームを無効化 (`touch-action: none`)

---

## 6. 操作仕様

### 6.1 PC操作

| 操作 | アクション |
|------|-----------|
| マウス移動 | 落下位置 (横方向) の調整 |
| 左クリック | ボール落下 |

### 6.2 スマートフォン操作

| 操作 | アクション |
|------|-----------|
| タッチ移動 (ドラッグ) | 落下位置 (横方向) の調整 |
| タッチ終了 (指を離す) | ボール落下 |

### 6.3 操作の補足

- ドロップ位置のガイドライン (縦の点線) を常時表示し、どこにボールが落ちるか視覚的にわかるようにする
- ボールはゲームエリアの左右壁の内側にのみ配置可能 (はみ出し防止)
- 落下アニメーション中は次の操作を受け付けない (クールダウン: 0.5秒)

---

## 7. 技術仕様

### 7.1 使用ライブラリ

| ライブラリ | バージョン | 読み込み方法 |
|-----------|-----------|-------------|
| Matter.js | 0.19.0以上 | CDN (`https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js`) |

### 7.2 ファイル構成

```
BallMergeGame/
  index.html    ... ゲーム本体 (HTML + CSS + JavaScript を単一ファイルに内包)
  GAME_DESIGN.md ... 本企画書
```

### 7.3 Matter.js 物理設定

| パラメータ | 値 | 説明 |
|-----------|-----|------|
| gravity.y | 1.5 | 重力 (デフォルト1.0より少し強め、テンポ良くするため) |
| restitution | 0.3 | 反発係数 (ボールが適度に跳ねる) |
| friction | 0.1 | 摩擦係数 |
| frictionAir | 0.01 | 空気抵抗 |
| slop | 0.5 | 衝突許容値 (めり込み防止) |

### 7.4 衝突検出・合体処理

```
処理フロー:
1. Matter.Events.on(engine, 'collisionStart', callback)
2. 衝突したペアの両方が同じレベルのボールか判定
3. 同レベルならば:
   a. 両ボールの中間座標を計算
   b. 両ボールをワールドから除去
   c. 1段階上のボールを中間座標に生成
   d. スコア加算 + 連鎖カウント更新
   e. エフェクト表示
4. レベル11同士の場合:
   a. 両ボールをワールドから除去
   b. ボーナススコア加算
   c. 特別エフェクト表示
```

### 7.5 ゲームオーバー判定

```
処理フロー:
1. 毎フレーム、全ボールのY座標を確認
2. デッドラインより上にボールが存在する場合、タイマー開始
3. 2秒間継続してデッドラインを超えていたらゲームオーバー
4. デッドライン以下に戻った場合、タイマーリセット
※落下直後のボール (生成から1秒以内) はデッドライン判定から除外
```

### 7.6 描画処理

- Matter.jsのレンダラーは使用せず、独自のCanvas描画ループを実装
- `requestAnimationFrame` で60FPS描画
- 描画順序:
  1. 背景クリア
  2. 壁の描画
  3. デッドライン描画
  4. 全ボール描画 (物理ボディの座標・角度を反映)
  5. ドロップガイドライン描画
  6. 次のボールプレビュー描画
  7. UI (スコア等) 描画
  8. エフェクト描画
  9. ゲームオーバーオーバーレイ (該当時)

### 7.7 パフォーマンス対策

| 対策 | 詳細 |
|------|------|
| ボール数上限 | 最大50個。超過時は最古のボールに警告表示 |
| 物理ステップ | `Matter.Engine.update(engine, 1000/60)` で固定ステップ |
| 静止判定 | 極低速のボールはスリープさせる (`enableSleeping: true`) |
| 合体キュー | 1フレーム内に複数合体が発生した場合、キューに入れて順次処理 |

---

## 8. エフェクト・演出

| 演出 | タイミング | 内容 |
|------|-----------|------|
| 合体パーティクル | ボール合体時 | 合体地点から8方向に小さな丸が飛び散り、フェードアウト (0.5秒) |
| 連鎖テキスト | 2連鎖以上発生時 | 「X Chain!」テキストが拡大しながらフェードアウト (1秒) |
| ボール揺れ | デッドライン超過中 | 画面全体が微かに振動 (警告演出) |
| 消滅フラッシュ | バランスボール消滅時 | 画面全体が一瞬白くフラッシュ + 大きなパーティクル |
| スコア加算 | スコア増加時 | 加算値が合体地点から上方にフロート表示して消える |

---

## 9. 拡張案 (将来実装候補)

| 機能 | 概要 | 優先度 |
|------|------|:------:|
| サウンド | 合体SE、BGM、ゲームオーバーSE | 高 |
| ランキング | オンラインランキング (Firebase等) | 中 |
| スキン変更 | ボールのデザインテーマ変更 (フルーツ、惑星等) | 中 |
| 難易度選択 | 出現ボール範囲や重力の変更 | 低 |
| 実績システム | 「初めてバランスボールを作った」等 | 低 |
| シェア機能 | Twitter/X等にスコアを共有 | 低 |

---

## 10. 開発マイルストーン

| フェーズ | 内容 | 目安 |
|---------|------|------|
| Phase 1 | 物理エンジン基盤構築 (壁、重力、ボール生成・落下) | 1日 |
| Phase 2 | 合体ロジック実装 (衝突検出、進化、消滅) | 1日 |
| Phase 3 | UI実装 (スコア、Next、ゲームオーバー、リトライ) | 0.5日 |
| Phase 4 | 演出実装 (パーティクル、連鎖表示、フロートスコア) | 0.5日 |
| Phase 5 | モバイル対応・レスポンシブ調整・テスト | 0.5日 |
| Phase 6 | バランス調整 (ボールサイズ、スコア、重力等) | 0.5日 |
